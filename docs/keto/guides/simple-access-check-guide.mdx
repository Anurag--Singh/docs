---
title: Create and Check Relationship
---

import Mermaid from "@site/src/theme/Mermaid"
import CodeTabs from "@site/src/theme/CodeTabs"

This guide will explain how you can use the Ory Permission [check-API](../concepts/api-overview.mdx#check-relation-tuple) to check
whether a [subject](../concepts/subjects.mdx) has a specific [relation](../concepts/relation-tuples.mdx) on an
[object](../concepts/objects.mdx). Typically, the result is used for restricting access to that object.

## Synchronous authorization flow

We recommend offloading the whole burden of access control to the Ory Permission Service. Typically, this means that the
application forwards every incoming request as a check request. The following chart demonstrates how such a flow can look like:

<Mermaid
  chart={`
sequenceDiagram
    participant U as User 'john'
    participant A as Application
    participant K as Ory Permission Service
%%
    U->>A: readDocument(todo_list.txt)
    A->>K: check(is User:john allowed to read on Document:todo_list.txt)
%%
    alt is allowed
      K-->>A: true
      A-->>U: document content
    else isn't allowed
      K-->>A: false
      A-->>U: Error 403
    end
`}
/>

As a first step, the application has to authenticate the user reliably to provide the subject to Keto. This can be achieved by
using [Ory Identities](https://www.ory.sh/kratos/docs/) or any other authentication system. <!-- TODO reference to Ory Identites -->

The application then determines the correct permission check from the request (here `read` of the document `todo_list.txt`).
The permission check is then performed against the [check-API](../concepts/api-overview.mdx#check-relation-tuple). In this
example, the application is asking `is User:john allowed to read on Document:todo_list.txt?`.

This question is encoded as the following [relation tuple](../concepts/relation-tuples.mdx):

```keto-relationships
User:john is owner of Message:02y_15_4w350m3
(member of Group:admins) is reader of Message:02y_15_4w350m3 // some comment
is User:john allowed to read of Message:02y_15_4w350m3?
```

:::caution Important

It's up to the application and its defined relation tuples how the check requests have to be encoded. In this example we assume
that the known cipher messages are stored in Ory Keto and access to the cleartext is encoded by the `decipher` relation.

:::

### Directly defined access

Ory Keto can know the exact relation tuple that the application is checking. Intuitively, this means that `john` was allowed to
`decipher` the message `02y_15_4w350m3` directly (imagine a "Share with `john`" input in a UI).

Try this yourself by first adding the relation tuple using the [write API](../concepts/api-overview.mdx#write-apis) (note that the
flag `--insecure-disable-transport-security` is necessary with newer versions of the Keto CLI if you run Keto without TLS):

<CodeTabs sampleId="simple-access-check-guide/00-write-direct-access" version="v0.7.0-alpha.1" />

Now, we can use the check-API to verify that `john` is allowed to `decipher` the message:

<CodeTabs sampleId="simple-access-check-guide/01-check-direct-access" version="v0.7.0-alpha.1" />

### Indirectly defined access

On the other hand, it's possible to indirectly grant `john` access to the resource. This could be done by adding a group, lets
call it `hackers`. Now we can grant access to the resource to everyone in that group by adding the following relation tuple to Ory
Keto:

```keto-relation-tuples
messages:02y_15_4w350m3#decipher@(groups:hackers#member)
```

We also have to make `john` a `member` of `hackers` by adding the relation tuple:

```keto-relation-tuples
groups:hackers#member@john
```

Now, when Keto receives above check request, it will resolve the [subject set](../concepts/subjects.mdx#subject-sets)

```keto-relation-tuples
groups:hackers#member
```

and determine that `john` is a subject in the resulting set. Therefore, it approves the check request.

There is no limit on the number of indirections through subject sets. It's however important to follow our
[best practices](./access-control-list-design-best-practices.mdx) to ensure a good [performance](../performance.mdx).

## Caching Keto responses

We don't recommend that you cache the responses from Ory Keto. It's designed to respond quickly and still provide
[some consistency guarantees](../concepts/snaptokens-evaluation-consistency.mdx). For the revocation of access it's important to
not use a local cache. Be ensured that Ory Keto heavily utilizes caching wherever possible. If you still happen to find
unacceptably slow check requests, check that you follow our [best practices](./access-control-list-design-best-practices.mdx) for
good [performance](../performance.mdx), or open an issue if the problem still persists.

## Conclusion

We learned how to integrate check requests and access control into an application using Ory Keto's
[check-API](../concepts/api-overview.mdx#check-relation-tuple).
